function getNewColor(t){this.colors||(this.colors={},this.count={}),this.colors[t]||(this.colors[t]=randomColor({hue:t,count:18,luminosity:"dark"}),this.count[t]=0);var e=this.colors[t][this.count[t]];return this.count[t]++,e}app.factory("map",["group","memory",function(t,e){var o=this;o.map=null;var n=e.useCurrent=e.useCurrent||!0,a={},i=null,r=function(t){return t*Math.PI/180},l=function(t,e){var o=6378137,n=r(e.lat()-t.lat()),a=r(e.lng()-t.lng()),i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(r(t.lat()))*Math.cos(r(e.lat()))*Math.sin(a/2)*Math.sin(a/2),l=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return o*l},s=document.createElement("canvas");s.width=32,s.height=48;var c=s.getContext("2d"),g=function(t,e){var o=t.toUpperCase().split(" ");return o=o.length>1?o[0].substr(0,1)+o[1].substr(0,1):o[0],c.clearRect(0,0,32,48),c.fillStyle=getNewColor(e?"blue":"orange"),c.beginPath(),c.arc(16,16,16,0,Math.PI,!0),c.bezierCurveTo(0,32,16,32,16,48),c.bezierCurveTo(16,32,32,32,32,16),c.closePath(),c.fill(),c.font="bold 18px Arial",c.textAlign="center",c.textBaseline="middle",c.fillStyle="white",c.fillText(o.substr(0,2),16,16,24),s.toDataURL()};o.createMap=function(){if(!o.map)if(mapsReady){var t=document.getElementById("map-view"),e={zoom:18,maxZoom:18};o.location&&(e.center=o.location),o.map=new google.maps.Map(t,e)}else setTimeout(o.createMap,10)},o.centerMap=function(t,e){t=t||o.location.lat,e=e||o.location.lng,o.map.setCenter({lat:t,lng:e})},o.requestLocation=function(t){!o.location&&n?navigator.geolocation.getCurrentPosition(function(e){o.location={lat:e.coords.latitude,lng:e.coords.longitude},t(o.location),navigator.geolocation.watchPosition(function(t){n&&(o.location.lat=t.coords.latitude,o.location.lng=t.coords.longitude)})},function(t){console.log(t)}):t(o.location)};var m=function(){var e=t.members,n=0;for(var i in e)e[i].ignore||(i in a?a[i].setPosition({lat:e[i].lat,lng:e[i].lng}):o.addPerson(i,e[i].lat,e[i].lng));var r=new google.maps.LatLngBounds;for(var i in a)i in e&&!e[i].ignore?(r.extend(a[i].getPosition()),n++):o.removePerson(i);n&&(o.map.setCenter(r.getCenter()),o.map.fitBounds(r))};return o.search=function(e){var n=0,a=new google.maps.Map(document.createElement("div"),{location:o.location,zoom:18}),i=function(e){for(var o=0,a=0;a<e.types.length;a++)o+=t.options.types[e.types[a]]||0;var i=l(g.location,e.geometry.location);e.score=o*g.radius/(n*i)},r=new google.maps.LatLngBounds;for(var s in t.members){var c=t.members[s];c&&!c.ignore&&r.extend(new google.maps.LatLng(c.lat,c.lng))}var g={location:r.getCenter(),radius:1619*t.options.radius||1619,types:[]};for(var m in t.options.types)g.types.push(m),n+=t.options.types[m];g.types.sort(function(e,o){return t.options.types[e]<t.options.types[o]}),g.types.splice(3,g.types.length);var u=new google.maps.places.PlacesService(a);u.nearbySearch(g,function(t){for(var o=0;o<t.length;o++)i(t[o]);t.sort(function(t,e){return e.score-t.score}),t.splice(5,t.length),e(t)})},o.addPerson=function(e,i,r){e in a?a[e].setPosition({lat:i,lng:r}):(a[e]=new google.maps.Marker({position:{lat:i,lng:r},map:o.map,title:e,animation:google.maps.Animation.DROP}),a[e].setIcon(g(e)),google.maps.event.addListener(a[e],"dragend",function(){n||(t.members[e].lat=a[e].getPosition().lat(),t.members[e].lng=a[e].getPosition().lng())}))},o.setLocation=function(n){i=new google.maps.Marker({title:n.name,position:n.geometry.location,map:o.map,icon:"images/location.png"}),o.map.setCenter(i.getPosition()),google.maps.event.addListener(i,"click",function(){var o="https://www.google.com/maps/dir/",a={lat:t.members[e.name].lat,lng:t.members[e.name].lng};o+=a.lat+","+a.lng,o+="/"+n.name.replace(/ /g,"+"),window.open(o)})},o.removePerson=function(t){a[t].setMap(null),delete a[t]},o.toggleLocationMode=function(){e.name&&(n=!n,e.useCurrent=n,a[e.name].setDraggable(!a[e.name].getDraggable()))},o.listen=function(){t.onUpdate(m)},o}]);