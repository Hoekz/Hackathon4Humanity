function getNewColor(t){this.colors||(this.colors={},this.count={}),this.colors[t]||(this.colors[t]=randomColor({hue:t,count:18,luminosity:"dark"}),this.count[t]=0);var o=this.colors[t][this.count[t]];return this.count[t]=(this.count[t]+1)%18,console.log(this.colors),o}app.factory("map",["group","memory",function(t,o){var e=this;e.map=null;var n=o.useCurrent=o.useCurrent||!0,a={},i=[],l=null,s=null,r=(document.createElement("div"),function(t){return t*Math.PI/180}),c=function(t,o){var e=6378137,n=r(o.lat()-t.lat()),a=r(o.lng()-t.lng()),i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(r(t.lat()))*Math.cos(r(o.lat()))*Math.sin(a/2)*Math.sin(a/2),l=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return e*l},g=document.createElement("canvas");g.width=32,g.height=48;var u=g.getContext("2d"),m=function(t,o){var e=t.toUpperCase().split(" ");return e=e.length>1?e[0].substr(0,1)+e[1].substr(0,1):e[0],u.clearRect(0,0,32,48),u.fillStyle=o?"#03c3e2":"#F97B66",u.beginPath(),u.arc(16,16,16,0,Math.PI,!0),u.bezierCurveTo(0,32,16,32,16,48),u.bezierCurveTo(16,32,32,32,32,16),u.closePath(),u.fill(),u.font="bold 18px Arial",u.textAlign="center",u.textBaseline="middle",u.fillStyle="white",u.fillText(e.substr(0,2),16,16,24),g.toDataURL()};e.createMap=function(){if(mapsReady){var t=document.getElementById("map-view"),o={zoom:18,maxZoom:18};e.location&&(o.center=e.location),e.map=new google.maps.Map(t,o);for(var n in a)a[n].setMap(e.map);p()}},e.centerMap=function(t,o){t=t||e.location.lat,o=o||e.location.lng,e.map.setCenter({lat:t,lng:o})},e.requestLocation=function(t){!e.location&&n?navigator.geolocation.getCurrentPosition(function(o){e.location={lat:o.coords.latitude,lng:o.coords.longitude},t(e.location),navigator.geolocation.watchPosition(function(t){n&&(e.location.lat=t.coords.latitude,e.location.lng=t.coords.longitude)})},function(t){console.log(t)}):t(e.location)};var p=function(){var o=t.members,n=0,i=!1;for(var l in o)o[l].ignore||(l in a?a[l].setPosition({lat:o[l].lat,lng:o[l].lng}):(e.addPerson(l,o[l].lat,o[l].lng),i=!0));var s=new google.maps.LatLngBounds;for(var l in a)l in o&&!o[l].ignore?(s.extend(a[l].getPosition()),n++):(e.removePerson(l),i=!0);if(n&&i){if(e.map.setCenter(s.getCenter()),t.finalized()){var r=new google.maps.LatLng(t.location.lat,t.location.lng);s.extend(r),e.map.setCenter(r)}e.map.fitBounds(s)}};return e.search=function(o){var n=0,a=new google.maps.Map(document.createElement("div"),{location:e.location,zoom:18}),i=function(o){for(var e=0,a=0;a<o.types.length;a++)e+=t.options.types[o.types[a]]||0;var i=c(g.location,o.geometry.location);o.score=e*g.radius/(n*i)},l=new google.maps.LatLngBounds;for(var s in t.members){var r=t.members[s];r&&!r.ignore&&l.extend(new google.maps.LatLng(r.lat,r.lng))}var g={location:l.getCenter(),radius:1619*t.options.radius||1619,types:[]};for(var u in t.options.types)g.types.push(u),n+=t.options.types[u];g.types.sort(function(o,e){return t.options.types[o]<t.options.types[e]}),g.types.splice(3,g.types.length);var m=new google.maps.places.PlacesService(a);m.nearbySearch(g,function(t){for(var e=0;e<t.length;e++)i(t[e]);t.sort(function(t,o){return o.score-t.score}),t.splice(5,t.length),o(t)})},e.addPerson=function(o,i,l){o in a?a[o].setPosition({lat:i,lng:l}):(a[o]=new google.maps.Marker({position:{lat:i,lng:l},map:e.map,title:o,animation:google.maps.Animation.DROP}),a[o].setIcon(m(o)),google.maps.event.addListener(a[o],"dragend",function(){n||(t.members[o].lat=a[o].getPosition().lat(),t.members[o].lng=a[o].getPosition().lng())}))},e.setLocations=function(o){s||(s=new google.maps.InfoWindow({content:"",maxWidth:300}));for(var n=function(){var t=this.resultRef;s.setContent("<div class='display-result'>"+t.name+"</div><div class='choose-result' onclick='useResult("+JSON.stringify(t.id)+")'>Choose</div>"),s.open(e.map,this)},a=0;a<i.length;a++)i[a].setMap(null);if(i=[],t.finalized())return e.finalLocation();for(var a=0;a<o.length;a++)i.push(new google.maps.Marker({title:o[a].name,position:o[a].geometry.location,map:e.map,icon:m(a+1+"",!0)})),i[a].resultRef=o[a],google.maps.event.addListener(i[a],"click",n)},e.finalLocation=function(){return l?null:(l=new google.maps.Marker({position:new google.maps.LatLng(t.location.lat,t.location.lng),icon:"images/location.png",title:t.location.name,map:e.map}),e.map.setCenter(l.getPosition()),void google.maps.event.addListener(l,"click",function(){var e="https://www.google.com/maps/dir/",n={lat:t.members[o.name].lat,lng:t.members[o.name].lng};e+=n.lat+","+n.lng,e+="/"+t.location.name.replace(/ /g,"+"),window.open(e)}))},e.removePerson=function(t){a[t].setMap(null),delete a[t]},e.toggleLocationMode=function(){o.name&&(n=!n,o.useCurrent=n,a[o.name].setDraggable(!a[o.name].getDraggable()))},e.listen=function(){t.onUpdate(p)},e.onChoose=function(t){useResult=t},e}]);var useResult=function(){};