app.factory("map",["group","memory",function(t,e){var n=this;n.map=null;var o=e.useCurrent=e.useCurrent||!0,a={},i=null,r=function(t){return t*Math.PI/180},l=function(t,e){var n=6378137,o=r(e.lat()-t.lat()),a=r(e.lng()-t.lng()),i=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r(t.lat()))*Math.cos(r(e.lat()))*Math.sin(a/2)*Math.sin(a/2),l=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return n*l},s=document.createElement("canvas");s.width=32,s.height=48;var c=s.getContext("2d"),g=function(t){var e=t.toUpperCase().split(" ");return e=e.length>1?e[0].substr(0,1)+e[1].substr(0,1):e[0],c.clearRect(0,0,32,48),c.fillStyle=randomColor({luminosity:"dark"}),c.beginPath(),c.arc(16,16,16,0,Math.PI,!0),c.bezierCurveTo(0,32,16,32,16,48),c.bezierCurveTo(16,32,32,32,32,16),c.closePath(),c.fill(),c.font="bold 18px Arial",c.textAlign="center",c.textBaseline="middle",c.fillStyle="white",c.fillText(e.substr(0,2),16,16,24),s.toDataURL()};n.createMap=function(){if(!n.map)if(mapsReady){var t=document.getElementById("map-view"),e={zoom:18,maxZoom:18};n.location&&(e.center=n.location),n.map=new google.maps.Map(t,e)}else setTimeout(n.createMap,10)},n.centerMap=function(t,e){t=t||n.location.lat,e=e||n.location.lng,n.map.setCenter({lat:t,lng:e})},n.requestLocation=function(t){!n.location&&o?navigator.geolocation.getCurrentPosition(function(e){n.location={lat:e.coords.latitude,lng:e.coords.longitude},t(n.location),navigator.geolocation.watchPosition(function(t){o&&(n.location.lat=t.coords.latitude,n.location.lng=t.coords.longitude)})},function(t){console.log(t)}):t(n.location)};var m=function(){var e=t.members;for(var o in e)e[o].ignore||(o in a?a[o].setPosition({lat:e[o].lat,lng:e[o].lng}):n.addPerson(o,e[o].lat,e[o].lng));var i=new google.maps.LatLngBounds;for(var o in a)o in e&&!e[o].ignore?i.extend(a[o].getPosition()):n.removePerson(o);n.map.setCenter(i.getCenter()),n.map.fitBounds(i)};return n.search=function(e){var o=0,a=new google.maps.Map(document.createElement("div"),{location:n.location,zoom:18}),i=function(e){for(var n=0,a=0;a<e.types.length;a++)n+=t.options.types[e.types[a]]||0;var i=l(g.location,e.geometry.location);e.score=n*g.radius/(o*i)},r=new google.maps.LatLngBounds;for(var s in t.members){var c=t.members[s];c&&!c.ignore&&r.extend(new google.maps.LatLng(c.lat,c.lng))}var g={location:r.getCenter(),radius:1619*t.options.radius||1619,types:[]};for(var m in t.options.types)g.types.push(m),o+=t.options.types[m];g.types.sort(function(e,n){return t.options.types[e]<t.options.types[n]}),g.types.splice(3,g.types.length);var p=new google.maps.places.PlacesService(a);p.nearbySearch(g,function(t){for(var n=0;n<t.length;n++)i(t[n]);t.sort(function(t,e){return e.score-t.score}),t.splice(5,t.length),e(t)})},n.addPerson=function(e,i,r){e in a?a[e].setPosition({lat:i,lng:r}):(a[e]=new google.maps.Marker({position:{lat:i,lng:r},map:n.map,title:e,animation:google.maps.Animation.DROP}),a[e].setIcon(g(e)),google.maps.event.addListener(a[e],"dragend",function(){o||(t.members[e].lat=a[e].getPosition().lat(),t.members[e].lng=a[e].getPosition().lng())}))},n.setLocation=function(o){i=new google.maps.Marker({title:o.name,position:o.geometry.location,map:n.map,icon:"images/location.png"}),n.map.setCenter(i.getPosition()),google.maps.event.addListener(i,"click",function(){var n="https://www.google.com/maps/dir/",a={lat:t.members[e.name].lat,lng:t.members[e.name].lng};n+=a.lat+","+a.lng,n+="/"+o.name.replace(/ /g,"+"),window.open(n)})},n.removePerson=function(t){a[t].setMap(null),delete a[t]},n.toggleLocationMode=function(){e.name&&(o=!o,e.useCurrent=o,a[e.name].setDraggable(!a[e.name].getDraggable()))},n.listen=function(){t.onUpdate(m)},n}]);